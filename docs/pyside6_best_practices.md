# PySide6 アプリケーション開発ベストプラクティス (2024年版)

本文書は、Windows環境においてPySide6を使用したデスクトップアプリケーションを開発・配布するためのガイドラインです。特に「exe化を行わない」「フォルダ配布によるポータブル化」「企業内利用」を前提としています。

---

## 1. アプリケーションアーキテクチャ

大規模なアプリケーション開発に耐えうる、保守性の高い構成を推奨します。

### 1.1 ディレクトリ構成
ソースコード(`src`)、UI定義(`ui`)、リソース(`assets`)、テスト(`tests`)を明確に分離します。

```
ProjectRoot/
├── assets/                 # 画像、アイコン、スタイルシート (qss)
│   └── icons/
├── docs/                   # ドキュメント
├── src/                    # ソースコード
│   ├── components/         # 再利用可能なウィジェット
│   ├── models/             # データモデル (MVC/MVVM)
│   ├── views/              # ウィジェット、ウィンドウ
│   ├── utils/              # ユーティリティ関数
│   ├── main.py             # エントリーポイント
│   └── config.py           # 設定ファイル
├── tests/                  # テストコード (pytest)
├── ui/                     # Qt Designerファイル (.ui)
├── requirements.txt        # 依存ライブラリ
└── run_app.bat             # 起動スクリプト
```

### 1.2 UIとロジックの分離 (MVVM/MVC)
現状のコード(`main.py`内で`_setup_ui`を手書き)は小規模なら問題ありませんが、画面が複雑になると保守が困難になります。以下のいずれかのアプローチを推奨します。

*   **推奨: Qt Designer (.uiファイル) の利用**
    *   画面レイアウトをコードから分離でき、デザイナーとプログラマーの分業が可能になります。
    *   **方法A (動的ロード):** `QUiLoader`を使用して実行時に`.ui`ファイルを読み込む。開発サイクルが速い。
    *   **方法B (静的変換):** `pyside6-uic`コマンドで`.ui`を`.py`に変換し、クラスとして継承する。IDEの補完が効きやすく、配布時に`.ui`ファイルパスの問題が起きにくい。

### 1.3 シグナル・スロットの型安全性
PySide6のシグナル・スロット機構を使用する際は、型ヒントとデコレータを活用します。

```python
from PySide6.QtCore import Signal, Slot, QObject

class Worker(QObject):
    # シグナルの引数型を明示
    finished = Signal(bool, str)

    @Slot(int)
    def process_data(self, value: int):
        # 処理...
        self.finished.emit(True, "Success")
```

---

## 2. 実装のベストプラクティス

### 2.1 スレッド処理 (UIのフリーズ防止)
重い処理をメインスレッド(UIスレッド)で行うとアプリが応答なしになります。Python標準の`threading`ではなく、Qtの`QThread`または`QRunnable` + `QThreadPool`を使用することを推奨します。これにより、シグナルを使ったUIへの安全な通信が可能になります。

### 2.2 リソース管理 (.qrc)
画像やアイコンのパスは、実行環境によって変わる可能性があります。Qtリソースシステム(`.qrc`)を使用し、バイナリに埋め込むか、信頼できる相対パス解決ロジック(`pathlib`等)を導入してください。

### 2.3 エラーハンドリング
GUIアプリでは例外が発生してもコンソールが見えないため、気づかないことがあります。
`sys.excepthook`をオーバーライドし、未処理の例外をログファイルに書き出すか、エラーダイアログを表示する仕組みを導入してください。

---

## 3. 配布戦略 (exe化しない・インストール不要)

「Windows Embeddable Package (埋め込み用Python)」を使用し、Python環境ごと配布する方法です。

### 3.1 準備手順

1.  **Embeddable Pythonのダウンロード**:
    [Python公式サイト](https://www.python.org/downloads/windows/)から `Windows embeddable package (64-bit)` をダウンロードし、プロジェクトフォルダ内に展開します（例: `python-embed/`）。

2.  **`site-packages` の有効化**:
    展開したフォルダ内の `python3xx._pth` ファイルをテキストエディタで開き、`#import site` の行のコメントアウトを外して `import site` にします。これにより、pipでインストールしたライブラリが読み込まれるようになります。

3.  **pipのインストール**:
    Embeddable版にはpipが含まれていません。
    *   `https://bootstrap.pypa.io/get-pip.py` をダウンロード。
    *   コマンドプロンプトで `python-embed\python.exe get-pip.py` を実行。

4.  **依存ライブラリのインストール**:
    開発環境のライブラリをそのままコピーするのではなく、Embeddable環境に対してインストールします。
    ```cmd
    python-embed\python.exe -m pip install -r requirements.txt
    ```
    ※ `PySide6` はサイズが大きいため、不要なモジュール（Qt3DやWebEngineなど）を削除して軽量化することも検討可能です（ただし依存関係に注意）。

5.  **起動スクリプトの作成**:
    ユーザーがダブルクリックで起動できるよう、バッチファイル(`run.bat`)を作成します。

    ```batch
    @echo off
    cd /d %~dp0
    start "" "python-embed\pythonw.exe" "src\main.py"
    ```
    *   `pythonw.exe` を使うことで、黒いコンソール画面を表示せずに起動できます。

---

## 4. 企業利用における考慮事項 (法務・セキュリティ)

### 4.1 ライセンス (LGPL v3)
PySide6 (Qt for Python) は **LGPL v3** ライセンスです。企業内で独自のアプリケーション（プロプライエタリ・ソフトウェア）として利用する場合、以下の点を遵守すればソースコードの公開義務は発生しません。

1.  **動的リンクの利用**: Pythonの `import PySide6` は動的リンクとみなされます。PySide6自体を改変・静的リンクしない限り、アプリケーション側のソースコードは公開不要です。
2.  **リバースエンジニアリングの許可**: LGPLの要件として、ユーザーがライブラリ（PySide6/Qt）を新しいバージョンに置き換えて動作させることを妨げてはいけません。「フォルダ配布」形式はこの要件を自然に満たしやすいため、exe化(PyInstaller --onefile)するよりもコンプライアンス的に安全です。
3.  **ライセンスの明示**: アプリケーションの「About」画面やドキュメントに、PySide6/Qtを使用していることと、そのライセンス条文へのリンクを含める必要があります。

### 4.2 セキュリティ
Pythonスクリプトとして配布するため、以下のリスクがあります。

*   **ソースコードの可読性**: フォルダ内の `.py` ファイルは誰でも閲覧・編集可能です。
    *   *対策*: 重要なロジック（APIキーや独自のアルゴリズム）はサーバーサイドに置くか、C++で拡張モジュール化することを検討してください。`pyc` (バイトコード) 配布でもある程度の難読化にはなりますが、完全ではありません。
*   **改ざんリスク**: 悪意のあるユーザーがスクリプトを書き換える可能性があります。
    *   *対策*: 企業内ネットワーク(イントラネット)のアクセス権限で、一般ユーザーには「読み取り専用」権限を与える等の運用対処が最も現実的です。
*   **Windows SmartScreen**: 署名のない `.bat` や `python.exe` は、実行時に「WindowsによってPCが保護されました」という警告が出ることがあります。
    *   *対策*: 組織内で配布する場合、信頼済み証明書でコード署名を行うか、グループポリシーで許可設定を行う必要があります。

### 4.3 運用・保守
*   **アップデート**: フォルダごとの差し替え運用が基本となります。設定ファイル（`config.ini`やSQLiteデータベース）は、アプリケーションフォルダ外（`%APPDATA%`など）に保存するように設計すると、アプリ本体のフォルダを丸ごと上書き更新してもユーザーデータが消えません。

---

**まとめ**
Windowsでのフォルダ配布方式は、インストーラー不要で手軽に展開できる反面、セキュリティとライセンスの理解が必要です。特にLGPL遵守のための「ライブラリ置換可能性」の維持と、ソースコードが見える前提での設計が重要になります。
